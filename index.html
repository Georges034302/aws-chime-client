<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AWS Chime Client</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <h1>AWS Chime Client</h1>

  <!-- Authentication Status -->
  <div id="auth-section">
    <div id="auth-status" style="margin-bottom:10px; font-weight:bold; color:#333;">
      Not logged in
    </div>

    <button id="loginButton">Login</button>
    <button id="logoutButton" style="display:none;">Logout</button>
  </div>

  <hr />

  <!-- Meeting Join Section -->
  <div id="meeting-section" style="display:none;">
    <div>
      <label>Meeting ID:</label>
      <input id="meetingId" />
    </div>

    <div>
      <label>Your Name:</label>
      <input id="name" />
    </div>

    <div>
      <label>Region:</label>
      <select id="region">
        <option value="ap-southeast-2">ap-southeast-2</option>
        <option value="us-east-1">us-east-1</option>
        <option value="us-west-2">us-west-2</option>
      </select>
    </div>

    <button id="joinButton">Join Meeting</button>
    <button id="leaveButton">Leave</button>

    <div id="status" style="margin-top:10px; color:#444;">Status: Waiting...</div>

    <hr />

    <!-- Devices -->
    <div>
      <label>Camera:</label>
      <select id="cameraSelect"></select>
    </div>
    <div>
      <label>Microphone:</label>
      <select id="micSelect"></select>
    </div>

    <div>
      <label>Background:</label>
      <select id="bgMode">
        <option value="none">None</option>
        <option value="blur">Blur</option>
        <option value="image">Image</option>
      </select>
      <input type="file" id="bgImage" accept="image/*" />
    </div>

    <button id="toggleVideo">Start Video</button>
    <button id="toggleAudio">Mute</button>
    <button id="shareScreen">Share Screen</button>

    <h3>Participants</h3>
    <ul id="participantsList"></ul>

    <div id="video-preview" class="video-box"></div>
    <div id="remote-videos" class="video-box"></div>

  </div>

  <script>
    /*************************************************************
     * COGNITO CONFIG
     *************************************************************/
    const COGNITO_DOMAIN = "chime-client-1764319994-19362";          
    const CLIENT_ID = "771598hr3p7fm4j9990585r63f";                 
    const REDIRECT_URI = window.location.hostname === 'localhost' ? "http://localhost:8000/" : "https://georges034302.github.io/aws-chime-client/";          
    const RESPONSE_TYPE = "token";
    const SCOPES = "openid+profile+email";

    let idToken = null;
    let userEmail = null;

    /*************************************************************
     * LOGIN + TOKEN PARSING
     *************************************************************/
    function parseTokenFromHash() {
      const hash = window.location.hash.substring(1);
      if (!hash) return;

      const params = new URLSearchParams(hash);
      idToken = params.get("id_token");

      if (idToken) {
        const parts = idToken.split(".");
        const decoded = JSON.parse(atob(parts[1]));
        userEmail = decoded.email || decoded.username;

        document.getElementById("auth-status").textContent =
          "Logged in as: " + userEmail;

        document.getElementById("loginButton").style.display = "none";
        document.getElementById("logoutButton").style.display = "inline-block";

        document.getElementById("meeting-section").style.display = "block";
      }
    }

    function login() {
      const url =
        `https://${COGNITO_DOMAIN}.auth.ap-southeast-2.amazoncognito.com/login?` +
        `client_id=${CLIENT_ID}&response_type=${RESPONSE_TYPE}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${SCOPES}`;

      window.location.href = url;
    }

    function logout() {
      window.location.href =
        `https://${COGNITO_DOMAIN}.auth.ap-southeast-2.amazoncognito.com/logout?` +
        `client_id=${CLIENT_ID}&logout_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }

    /*************************************************************
     * MODIFY FETCH TO ATTACH COGNITO TOKEN
     *************************************************************/
    const oldFetch = window.fetch;
    window.fetch = function (url, options = {}) {
      if (idToken) {
        options.headers = {
          ...(options.headers || {}),
          Authorization: idToken
        };
      }
      return oldFetch(url, options);
    };

    /*************************************************************/
    window.onload = () => {
      parseTokenFromHash();

      document.getElementById("loginButton").onclick = login;
      document.getElementById("logoutButton").onclick = logout;
    };
  </script>

  <script src="app.js"></script>
</body>
</html>
