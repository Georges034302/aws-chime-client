// Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
// WebAssembly modules: see https://static.sdkassets.chime.aws/bgblur/workers/NOTICES.txt for attribution.

(()=>{var t={868:t=>{var n,e=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(t){var e,r,i=void 0!==(t=t||{})?t:{};i.ready=new Promise((function(t,n){e=t,r=n}));var o,a={};for(o in i)i.hasOwnProperty(o)&&(a[o]=i[o]);var u,s=[],c="./this.program",l=function(t,n){throw n},f="";"undefined"!=typeof document&&document.currentScript&&(f=document.currentScript.src),n&&(f=n),f=0!==f.indexOf("blob:")?f.substr(0,f.lastIndexOf("/")+1):"",u=function(t,n,e){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200==r.status||0==r.status&&r.response?n(r.response):e()},r.onerror=e,r.send(null)};var _=i.print||console.log.bind(console),h=i.printErr||console.warn.bind(console);for(o in a)a.hasOwnProperty(o)&&(i[o]=a[o]);a=null,i.arguments&&(s=i.arguments),i.thisProgram&&(c=i.thisProgram),i.quit&&(l=i.quit);var p,d,g=[];i.wasmBinary&&(d=i.wasmBinary);var m,w=i.noExitRuntime||!0;"object"!=typeof WebAssembly&&z("no native wasm support detected");var b,y,v,A,E=!1,R="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function P(t,n,e){for(var r=n+e,i=n;t[i]&&!(i>=r);)++i;if(i-n>16&&t.subarray&&R)return R.decode(t.subarray(n,i));for(var o="";n<i;){var a=t[n++];if(128&a){var u=63&t[n++];if(192!=(224&a)){var s=63&t[n++];if((a=224==(240&a)?(15&a)<<12|u<<6|s:(7&a)<<18|u<<12|s<<6|63&t[n++])<65536)o+=String.fromCharCode(a);else{var c=a-65536;o+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else o+=String.fromCharCode((31&a)<<6|u)}else o+=String.fromCharCode(a)}return o}function W(t,n){return t?P(v,t,n):""}function x(t){b=t,i.HEAP8=y=new Int8Array(t),i.HEAP16=new Int16Array(t),i.HEAP32=A=new Int32Array(t),i.HEAPU8=v=new Uint8Array(t),i.HEAPU16=new Uint16Array(t),i.HEAPU32=new Uint32Array(t),i.HEAPF32=new Float32Array(t),i.HEAPF64=new Float64Array(t)}i.INITIAL_MEMORY;var M,U=[],k=[],I=[];function C(){return w||!1}var H,S,T,O=0,D=null,F=null;function L(t){O++,i.monitorRunDependencies&&i.monitorRunDependencies(O)}function B(t){if(O--,i.monitorRunDependencies&&i.monitorRunDependencies(O),0==O&&(null!==D&&(clearInterval(D),D=null),F)){var n=F;F=null,n()}}function z(t){i.onAbort&&i.onAbort(t),h(t+=""),E=!0,t="abort("+t+"). Build with -s ASSERTIONS=1 for more info.";var n=new WebAssembly.RuntimeError(t);throw r(n),n}function j(t){return t.startsWith("data:application/octet-stream;base64,")}function q(t){try{if(t==H&&d)return new Uint8Array(d);throw"both async and sync fetching of the wasm failed"}catch(t){z(t)}}function G(t){for(;t.length>0;){var n=t.shift();if("function"!=typeof n){var e=n.func;"number"==typeof e?void 0===n.arg?M.get(e)():M.get(e)(n.arg):e(void 0===n.arg?null:n.arg)}else n(i)}}function N(t,n){if(!E)if(n)t();else try{t()}catch(t){if(t instanceof nt)return;if("unwind"!==t)throw t&&"object"==typeof t&&t.stack&&h("exception thrown: "+[t,t.stack]),t}}function $(t){try{return m.grow(t-b.byteLength+65535>>>16),x(m.buffer),1}catch(t){}}i.preloadedImages={},i.preloadedAudios={},j(H="_cwt-wasm.wasm")||(S=H,H=i.locateFile?i.locateFile(S,f):f+S),T=function(){return performance.now()};var X={};function Y(){if(!Y.strings){var t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:c||"./this.program"};for(var n in X)void 0===X[n]?delete t[n]:t[n]=X[n];var e=[];for(var n in t)e.push(n+"="+t[n]);Y.strings=e}return Y.strings}var J,K={mappings:{},buffers:[null,[],[]],printChar:function(t,n){var e=K.buffers[t];0===n||10===n?((1===t?_:h)(P(e,0)),e.length=0):e.push(n)},varargs:void 0,get:function(){return K.varargs+=4,A[K.varargs-4>>2]},getStr:function(t){return W(t)},get64:function(t,n){return t}},Q={a:function(){z()},m:function(t,n){var e;if(0===t)e=Date.now();else{if(1!==t&&4!==t)return 28,A[tt()>>2]=28,-1;e=T()}return A[n>>2]=e/1e3|0,A[n+4>>2]=e%1e3*1e3*1e3|0,0},h:function(t,n){z("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},c:function(t,n){z("To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking")},o:function(t,n,e,r){!function(t,n,e,r){var i=r?"":"al "+t;u(t,(function(e){e||z('Assertion failed: Loading data file "'+t+'" failed (no arrayBuffer).'),n(new Uint8Array(e)),i&&B()}),(function(n){if(!e)throw'Loading data file "'+t+'" failed.';e()})),i&&L()}(W(t),(function(t){N((function(){var r=V(t.length);v.set(t,r),M.get(e)(n,r,t.length),Z(r)}))}),(function(){r&&N((function(){M.get(r)(n)}))}),!0)},f:function(){return 2147483648},k:function(t,n,e){v.copyWithin(t,n,n+e)},l:function(t){var n,e=v.length,r=2147483648;if((t>>>=0)>r)return!1;for(var i=1;i<=4;i*=2){var o=e*(1+.2/i);if(o=Math.min(o,t+100663296),$(Math.min(r,((n=Math.max(t,o))%65536>0&&(n+=65536-n%65536),n))))return!0}return!1},n:function(t){for(var n=T();T()-n<t;);},d:function(t,n){var e=0;return Y().forEach((function(r,i){var o=n+e;A[t+4*i>>2]=o,function(t,n,e){for(var r=0;r<t.length;++r)y[n++>>0]=t.charCodeAt(r);y[n>>0]=0}(r,o),e+=r.length+1})),0},e:function(t,n){var e=Y();A[t>>2]=e.length;var r=0;return e.forEach((function(t){r+=t.length+1})),A[n>>2]=r,0},i:function(t){!function(t,n){var e;C(),e=t,C()||(i.onExit&&i.onExit(e),E=!0),l(e,new nt(e))}(t)},g:function(t){return 0},j:function(t,n,e,r,i){},b:function(t,n,e,r){for(var i=0,o=0;o<e;o++){for(var a=A[n+8*o>>2],u=A[n+(8*o+4)>>2],s=0;s<u;s++)K.printChar(t,v[a+s]);i+=u}return A[r>>2]=i,0}},V=(function(){var t={a:Q};function n(t,n){var e,r=t.exports;i.asm=r,x((m=i.asm.p).buffer),M=i.asm.B,e=i.asm.q,k.unshift(e),B()}function e(t){n(t.instance)}function o(n){return(d||"function"!=typeof fetch?Promise.resolve().then((function(){return q(H)})):fetch(H,{credentials:"same-origin"}).then((function(t){if(!t.ok)throw"failed to load wasm binary file at '"+H+"'";return t.arrayBuffer()})).catch((function(){return q(H)}))).then((function(n){return WebAssembly.instantiate(n,t)})).then(n,(function(t){h("failed to asynchronously prepare wasm: "+t),z(t)}))}if(L(),i.instantiateWasm)try{return i.instantiateWasm(t,n)}catch(t){return h("Module.instantiateWasm callback failed with error: "+t),!1}(d||"function"!=typeof WebAssembly.instantiateStreaming||j(H)||"function"!=typeof fetch?o(e):fetch(H,{credentials:"same-origin"}).then((function(n){return WebAssembly.instantiateStreaming(n,t).then(e,(function(t){return h("wasm streaming compile failed: "+t),h("falling back to ArrayBuffer instantiation"),o(e)}))}))).catch(r)}(),i.___wasm_call_ctors=function(){return(i.___wasm_call_ctors=i.asm.q).apply(null,arguments)},i._cwt_model_get_input_buffer=function(){return(i._cwt_model_get_input_buffer=i.asm.r).apply(null,arguments)},i._cwt_model_get_output_buffer=function(){return(i._cwt_model_get_output_buffer=i.asm.s).apply(null,arguments)},i._cwt_blur_destroy=function(){return(i._cwt_blur_destroy=i.asm.t).apply(null,arguments)},i._cwt_model_destroy=function(){return(i._cwt_model_destroy=i.asm.u).apply(null,arguments)},i._cwt_model_load_model=function(){return(i._cwt_model_load_model=i.asm.v).apply(null,arguments)},i._cwt_model_predict=function(){return(i._cwt_model_predict=i.asm.w).apply(null,arguments)},i._cwt_create_blur_processor=function(){return(i._cwt_create_blur_processor=i.asm.x).apply(null,arguments)},i._cwt_blur_get_input_buffer=function(){return(i._cwt_blur_get_input_buffer=i.asm.y).apply(null,arguments)},i._cwt_blur_get_output_buffer=function(){return(i._cwt_blur_get_output_buffer=i.asm.z).apply(null,arguments)},i._cwt_blur_process=function(){return(i._cwt_blur_process=i.asm.A).apply(null,arguments)},i._malloc=function(){return(V=i._malloc=i.asm.C).apply(null,arguments)}),Z=i._free=function(){return(Z=i._free=i.asm.D).apply(null,arguments)},tt=i.___errno_location=function(){return(tt=i.___errno_location=i.asm.E).apply(null,arguments)};function nt(t){this.name="ExitStatus",this.message="Program terminated with exit("+t+")",this.status=t}function et(t){function n(){J||(J=!0,i.calledRun=!0,E||(G(k),e(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),function(){if(i.postRun)for("function"==typeof i.postRun&&(i.postRun=[i.postRun]);i.postRun.length;)t=i.postRun.shift(),I.unshift(t);var t;G(I)}()))}t=t||s,O>0||(function(){if(i.preRun)for("function"==typeof i.preRun&&(i.preRun=[i.preRun]);i.preRun.length;)t=i.preRun.shift(),U.unshift(t);var t;G(U)}(),O>0||(i.setStatus?(i.setStatus("Running..."),setTimeout((function(){setTimeout((function(){i.setStatus("")}),1),n()}),1)):n()))}if(i.stringToUTF8=function(t,n,e){return function(t,n,e,r){if(!(r>0))return 0;for(var i=e,o=e+r-1,a=0;a<t.length;++a){var u=t.charCodeAt(a);if(u>=55296&&u<=57343&&(u=65536+((1023&u)<<10)|1023&t.charCodeAt(++a)),u<=127){if(e>=o)break;n[e++]=u}else if(u<=2047){if(e+1>=o)break;n[e++]=192|u>>6,n[e++]=128|63&u}else if(u<=65535){if(e+2>=o)break;n[e++]=224|u>>12,n[e++]=128|u>>6&63,n[e++]=128|63&u}else{if(e+3>=o)break;n[e++]=240|u>>18,n[e++]=128|u>>12&63,n[e++]=128|u>>6&63,n[e++]=128|63&u}}return n[e]=0,e-i}(t,v,n,e)},i.addFunction=function(t,n){return function(t,n){if(!p){p=new WeakMap;for(var e=0;e<M.length;e++){var r=M.get(e);r&&p.set(r,e)}}if(p.has(t))return p.get(t);var i=function(){if(g.length)return g.pop();try{M.grow(1)}catch(t){if(!(t instanceof RangeError))throw t;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH."}return M.length-1}();try{M.set(i,t)}catch(e){if(!(e instanceof TypeError))throw e;var o=function(t,n){if("function"==typeof WebAssembly.Function){for(var e={i:"i32",j:"i64",f:"f32",d:"f64"},r={parameters:[],results:"v"==n[0]?[]:[e[n[0]]]},i=1;i<n.length;++i)r.parameters.push(e[n[i]]);return new WebAssembly.Function(r,t)}var o=[1,0,1,96],a=n.slice(0,1),u=n.slice(1),s={i:127,j:126,f:125,d:124};for(o.push(u.length),i=0;i<u.length;++i)o.push(s[u[i]]);"v"==a?o.push(0):o=o.concat([1,s[a]]),o[1]=o.length-2;var c=new Uint8Array([0,97,115,109,1,0,0,0].concat(o,[2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0])),l=new WebAssembly.Module(c);return new WebAssembly.Instance(l,{e:{f:t}}).exports.f}(t,n);M.set(i,o)}return p.set(t,i),i}(t,n)},F=function t(){J||et(),J||(F=t)},i.run=et,i.preInit)for("function"==typeof i.preInit&&(i.preInit=[i.preInit]);i.preInit.length>0;)i.preInit.pop()();return et(),t.ready});t.exports=e}},n={};function e(r){var i=n[r];if(void 0!==i)return i.exports;var o=n[r]={exports:{}};return t[r](o,o.exports,e),o.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),(()=>{"use strict";var t=e(868),n=e.n(t),r=function(t,n,e,r){return new(e||(e=Promise))((function(i,o){function a(t){try{s(r.next(t))}catch(t){o(t)}}function u(t){try{s(r.throw(t))}catch(t){o(t)}}function s(t){var n;t.done?i(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(a,u)}s((r=r.apply(t,n||[])).next())}))};const i=self;let o=new class{constructor(){this._model_output_bytes=0,this._blur_output_bytes=0,this._blur_with_predict=!1,this._config={modelUrl:"",inputHeight:0,inputWidth:0,inputChannels:0,modelRangeMin:0,modelRangeMax:0},this._blur_config={channels:0,height:0,width:0}}initialize(t,e){return r(this,void 0,void 0,(function*(){let r=yield(async()=>WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11])))();this._cwt=yield n()({locateFile(n,i){if("_cwt-wasm.wasm"===n){if(r&&e)return e;if(t)return t}return i+n}})}))}loadBlur(t,n,e,i){return r(this,void 0,void 0,(function*(){this._blur_config.height=t,this._blur_config.width=n,this._blur_config.channels=e,this._cwt._cwt_create_blur_processor(t,n,e,i),this._blur_output_bytes=t*n*e}))}blur(t){if(void 0===this._cwt||null===this._cwt)return console.error("initialize() not called"),new ImageData(0,0);let n=this._cwt._cwt_blur_get_input_buffer();this._cwt.HEAPU8.set(t.data,n);const e=this._cwt._cwt_blur_process();if(0!=e)throw new Error(`failed to process blur, err: ${e}`);n=this._cwt._cwt_blur_get_output_buffer();const r=this._cwt.HEAPU8.slice(n,n+this._blur_output_bytes);return new ImageData(new Uint8ClampedArray(r),this._blur_config.width,this._blur_config.height)}blurOutput(){let t=this._cwt._cwt_blur_get_output_buffer();const n=this._cwt.HEAPU8.slice(t,t+this._blur_output_bytes);return new ImageData(new Uint8ClampedArray(n),this._blur_config.width,this._blur_config.height)}destroy(){var t,n;null===(t=this._cwt)||void 0===t||t._cwt_model_destroy(),null===(n=this._cwt)||void 0===n||n._cwt_blur_destroy()}blurWithPredictEnabled(){return this._blur_with_predict}loadModel(t,n,e){if(void 0===this._cwt||null===this._cwt)return console.error("initialize() not called before loading the model."),void e(-1);this._config=t,this._model_output_bytes=this._config.inputHeight*this._config.inputWidth*this._config.inputChannels,this._blur_with_predict=n>0,!0===this._blur_with_predict&&(this._blur_config.height=this._config.inputHeight,this._blur_config.width=this._config.inputWidth,this._blur_config.channels=this._config.inputChannels,this._blur_output_bytes=this._config.inputHeight*this._config.inputWidth*this._config.inputChannels);let r=this._cwt.addFunction(e,"vi"),i=4*this._config.modelUrl.length+1,o=this._cwt._malloc(i);this._cwt.stringToUTF8(this._config.modelUrl,o,i),this._cwt._cwt_model_load_model(o,this._config.inputHeight,this._config.inputWidth,this._config.inputChannels,this._config.modelRangeMin,this._config.modelRangeMax,r,n),this._cwt._free(o)}predict(t){if(void 0===this._cwt||null===this._cwt)return console.error("initialize() not called before using predict."),new ImageData(0,0);let n=this._cwt._cwt_model_get_input_buffer();this._cwt.HEAPU8.set(t.data,n);const e=this._cwt._cwt_model_predict();if(0!=e)throw new Error(`failed to execute prediction, err: ${e}`);n=this._cwt._cwt_model_get_output_buffer();const r=this._cwt.HEAPU8.slice(n,n+this._model_output_bytes);return new ImageData(new Uint8ClampedArray(r),this._config.inputWidth,this._config.inputHeight)}};i.addEventListener("message",(function(t){let n=t.data.payload;switch(t.data.msg){case"initialize":o.initialize(n.wasmPath,n.simdPath).then((()=>i.postMessage({msg:"initialize",payload:!0}))).catch((()=>i.postMessage({msg:"initialize",payload:!1})));break;case"loadBlur":o.loadBlur(n.height,n.width,n.channels,n.blurPixels).then((()=>i.postMessage({msg:"loadBlur",payload:!0})));break;case"blur":{const t=o.blur(n);i.postMessage({msg:"blur",payload:t},[t.data.buffer]);break}case"loadModel":o.loadModel(n,n.blurPixels,(t=>{i.postMessage({msg:"loadModel",payload:t})}));break;case"predict":{let n=[],e={output:o.predict(t.data.payload)};n.push(e.output.data.buffer),o.blurWithPredictEnabled()&&(e.blurOutput=o.blurOutput(),n.push(e.blurOutput.data.buffer)),i.postMessage({msg:"predict",payload:e},n);break}case"destroy":o.destroy();break;case"stop":self.close();break;default:console.log(`unknown operation ${t.data.msg}`)}}))})()})();